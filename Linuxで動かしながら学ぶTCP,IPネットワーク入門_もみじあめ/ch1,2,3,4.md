# TCP/IPとは

## 1章 : 前説

TCP : Transmission Control Protocol
IP : Internet Protocol

OSI参照モデル
- アプリケーション層
- プレゼンテーション層
- セッション層
- トランスポート層
- ネットワーク層
- データリンク層
- 物理層


実際のTCP/IPでの階層定義は、
- アプリケーション層
- トランスポート層
- インターネット層
- リンク層


TCP/IPは、IETF : Internet Engineering Task Forceが標準化団体
物理層とデータリンク層はIEEEが決めている。

## 2章 : ping, ip address, ip show, traceroute 

dockerでやることにする。

dockerでubuntuの起動
```sh
docker pull ubuntu:18.04
docker run -it -d --name ubuntu1804 ubuntu:18.04
docker exec -it ubuntu1804 /bin/bash
```

以下、docker内のubuntuで実行
```sh
apt-get update
apt-get -y install iproute2 iputils-ping traceroute tcpdump dnsmasq netcat-openbsd python3 curl wget gawk dnsutils procps 
```


```sh
ping -c 3 8.8.8.8 #googleのdns、私のproxy使った環境だと疎通できず
```
pingは、ICMP (Internet Control Message Protocol)を使用。


```sh
ip address show

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: tunl0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
3: ip6tnl0@NONE: <NOARP> mtu 1452 qdisc noop state DOWN group default qlen 1000
    link/tunnel6 :: brd ::
6: eth0@if7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
```
ifconfigじゃないんんだ。。。。


1:の後が、ネットワークインターフェース。
127.0.0.1がループバック。





パケットキャプチャをする。
別ターミナルで、以下やって、docker コンテナにアタッチ。
```sh
docker exec -it ubuntu1804 /bin/bash
```


localhost間のやりとりになってしまうが、requectして、replyが帰ってきている。
```sh
tcpdump -tn -i any icmp

tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes

IP 127.0.0.1 > 127.0.0.1: ICMP echo request, id 57, seq 1, length 64
IP 127.0.0.1 > 127.0.0.1: ICMP echo reply, id 57, seq 1, length 64
IP 127.0.0.1 > 127.0.0.1: ICMP echo request, id 57, seq 2, length 64
IP 127.0.0.1 > 127.0.0.1: ICMP echo reply, id 57, seq 2, length 64
IP 127.0.0.1 > 127.0.0.1: ICMP echo request, id 57, seq 3, length 64
IP 127.0.0.1 > 127.0.0.1: ICMP echo reply, id 57, seq 3, length 64

```


traceroute 
```sh
traceroute -n 10.168.72.2

traceroute to 10.168.72.2 (10.168.72.2), 30 hops max, 60 byte packets
 1  172.17.0.1  2.752 ms  2.696 ms  2.675 ms
 2  10.128.2.2  55.346 ms  55.308 ms  58.812 ms
 3  10.128.1.140  58.695 ms  58.658 ms  58.621 ms
 4  10.240.0.49  58.801 ms  82.219 ms  83.360 ms
 5  * * *
 6  * * *
 7  10.240.5.246  79.974 ms  48.345 ms  48.259 ms
 8  10.168.233.13  45.125 ms  52.175 ms  52.141 ms
 9  10.168.232.34  52.833 ms  52.678 ms  34.352 ms
10  10.168.72.2  33.238 ms  33.127 ms  16.339 ms
```

tracerouteは、TTLを活用して動作。
TTLは、ルータを通過する度にデクリメントされるヘッダ情報で、0になったらパケットが破棄される。
その際に、ルータによっては時間切りメッセージを返信する。これを利用する。


ルーティングテーブル

```sh
ip route show 

default via 172.17.0.1 dev eth0
172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.2
```

defaultは、他に該当しないやつ。defaultを、172.17.0.1に送りつけるという意味になるそう。
"他"は、172.17.0.0/16 になる。


## 3章 Network Namespace 

```sh
ip netns add helloworld 
```

dockerでやると、
> mount --make-shared /var/run/netns failed: Operation not permitted

で怒られる。

どうやらこれっぽい。
https://qiita.com/10mi8o/items/c816917572d764ca23af

```sh
docker run --privileged -it -d --name ubuntu1804 ubuntu:18.04
```



```sh

ip netns add ns1
ip netns add ns2 
ip link add ns1-veth0 type veth peer name ns2-veth0

ip link show  | grep veth

ip link set ns1-veth0 netns ns1 
ip link set ns2-veth0 netns ns2 

ip netns exec ns1 ip address add 192.0.2.1/24 dev ns1-veth0 
ip netns exec ns2 ip address add 192.0.2.2/24 dev ns2-veth0

ip netns exec ns1 ip link show ns1-veth0
ip netns exec ns2 ip link show ns2-veth0

ip netns exec ns1 ip link set ns1-veth0 up
ip netns exec ns2 ip link set ns2-veth0 up

ip netns exec ns1 ping -c 3 192.0.2.2


4: ns2-veth0@ns1-veth0: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
5: ns1-veth0@ns2-veth0: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
```




ルータを入れて見る。
```
ip netns delete ns1
ip netns delete ns2


ip netns add ns1
ip netns add router
ip netns add ns2

ip link add ns1-veth0 type veth peer name gw-veth0
ip link add ns2-veth0 type veth peer name gw-veth1

ip link set ns1-veth0 netns ns1
ip link set gw-veth0 netns router 
ip link set gw-veth1 netns router 
ip link set ns2-veth0 netns ns2

ip netns exec ns1 ip link set ns1-veth0 up 
ip netns exec router ip link set gw-veth0 up 
ip netns exec router ip link set gw-veth1 up 
ip netns exec ns2 ip link set ns2-veth0 up 

ip netns exec ns1 ip address add 192.0.2.1/24 dev ns1-veth0
ip netns exec router ip address add 192.0.2.254/23 dev gw-veth0

ip netns exec router ip address add 198.51.100.254/24 dev gw-veth1 
ip netns exec ns2 ip address add 198.51.100.1/24 dev ns2-veth0 


```